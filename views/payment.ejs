<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Get Floppy App</title>
        <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
        <script src="https://js.stripe.com/v3/"></script>
        <link rel="stylesheet" href="/stylesheets/index.css">
    </head>
    <body>
        <div class="header" style="display: flex; flex-direction: column; height: 100vh;">
            <div class="msg">
                <center>
                    <h1 class="pricing" id="pay-title" style="font-size: 2.5em;font-family: 'Open Sans', sans-serif; color: white;">Please enter your email</h1>
                </center>
                <input
                    type="email"
                    name="email"
                    id="pay-email"
                    placeholder="Enter your email here"
                >
                <!-- <input type="hidden" name="server_url" value="<%= serverUrl %>"/> -->
                <button id="submit" class="submit-button">Proceed</button>
            </div>
            <div style="flex-shrink: 0; margin-bottom: 0.2em;">
                <svg
                    class="waves"
                    xmlns="http://www.w3.org/2000/svg"
                    xmlns:xlink="http://www.w3.org/1999/xlink"
                    viewBox="0 24 150 28"
                    preserveAspectRatio="none"
                    shape-rendering="auto"
                >
                    <defs>
                        <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/>
                    </defs>
                    <g class="parallax">
                        <use
                            xlink:href="#gentle-wave"
                            x="48"
                            y="0"
                            fill="rgba(255,255,255,0.7)"
                        />
                        <use
                            xlink:href="#gentle-wave"
                            x="48"
                            y="3"
                            fill="rgba(255,255,255,0.5)"
                        />
                        <use
                            xlink:href="#gentle-wave"
                            x="48"
                            y="5"
                            fill="rgba(255,255,255,0.3)"
                        />
                        <use
                            xlink:href="#gentle-wave"
                            x="48"
                            y="7"
                            fill="#fff"
                        />
                    </g>
                </svg>
            </div>
        </div>
        <script>

            function validate_email(email) {
                if (email.match(/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/)){
                    return true;
                }

                return false;
            }

            document.getElementById("submit").addEventListener("click", () => {
                var email = document.getElementById("pay-email");

                if (validate_email(email.value)) {

                    $.ajax({
                        url: "/create-checkout-session/",
                        method: "POST",
                        contentType: "application/json",
                        data: JSON.stringify({ customerEmail: email.value }),
                        success: (data, status, xhr) => {
                            var stripe = Stripe("pk_test_51LZvkbICmfhOJ5j255o2Bdc7kbxg6laAP5JrYWIKRpyFmtiI1B54Ea8VT7A4NELktXA289uSxshfZUzNYuDIO9XG00Uj6oMfli");
                            // return stripe.redirectToCheckout({ sessionId: data.id });
                            document.getElementById("pay-title").textContent = "Redirecting to Stripe for Secure Checkout...";
                            window.location = data.url;
                        },
                        error: (xhr, status, err) => {
                            document.getElementById("pay-title").textContent = "An error occured while creating Secure Checkout Session."
                            console.error("Error: ", err);
                        },
                    });

                } else {
                    alert("The entered email is invalid.");
                    email.value = "";
                }
            })
        </script>
    </body>
</html>
